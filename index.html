<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥æœˆæ½­å¥½è¡Œå¤§å†’éšª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: #f0fdfa; touch-action: manipulation; }
        .hidden { display: none !important; }
        /* åœ–ç‰‡è£åˆ‡é‚è¼¯ */
        .sprite-bus { width: 120px; height: 60px; background: url('https://i.postimg.cc/MKCWGn6z/busandbusstaion-png.png') no-repeat; background-size: 400px auto; background-position: -20px -20px; }
        .sprite-station { width: 50px; height: 80px; background: url('https://i.postimg.cc/MKCWGn6z/busandbusstaion-png.png') no-repeat; background-size: 400px auto; background-position: -320px -10px; }
        /* æ‹¼åœ–æ¨£å¼ */
        .puzzle-slot { width: 80px; height: 80px; border: 2px dashed #ccc; background: #eee; }
        .puzzle-piece { width: 80px; height: 80px; background-image: url('https://i.postimg.cc/VLd6vyXZ/zhu-shi-jue.jpg'); background-size: 160px 160px; cursor: pointer; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col bg-white shadow-2xl relative">
    
    <!-- æ¸¬è©¦æ¨¡å¼æ¨™ç±¤ -->
    <div id="debug-tag" class="hidden absolute top-0 left-0 bg-red-500 text-white text-[10px] px-2 z-50">æ¸¬è©¦æ¨¡å¼ï¼šGPS & é™åˆ¶å·²é—œé–‰</div>

    <!-- 1. ç™»å…¥ç•«é¢ -->
    <div id="view-login" class="flex flex-col items-center justify-center flex-grow p-6 text-center">
        <img src="https://i.postimg.cc/VLd6vyXZ/zhu-shi-jue.jpg" class="w-full rounded-2xl mb-8 shadow-lg">
        <h1 class="text-3xl font-black text-teal-800 mb-2">æ—¥æœˆæ½­å¥½è¡Œå¤§å†’éšª</h1>
        <p class="text-teal-600 mb-10 font-medium">æ­ä¹˜å°ç£å¥½è¡Œï¼Œé–‹å•Ÿé©šå–œæ—…ç¨‹</p>
        <button id="btn-login" class="w-full bg-teal-600 hover:bg-teal-700 text-white py-4 rounded-2xl font-bold text-xl shadow-xl transition-all active:scale-95">
            Google å¸³è™Ÿå¿«é€Ÿç™»å…¥
        </button>
    </div>

    <!-- 2. GPS æª¢æŸ¥ -->
    <div id="view-gps" class="hidden flex flex-col items-center justify-center flex-grow p-8 text-center">
        <div class="w-24 h-24 bg-teal-100 rounded-full flex items-center justify-center mb-6 animate-bounce">
            <span class="text-4xl">ğŸ“</span>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-4">ç¢ºèªæ‚¨çš„ä½ç½®</h2>
        <p id="gps-status" class="text-gray-500 leading-relaxed">å–”ç†Šçµ„é•·æ­£åœ¨ç¢ºèªæ‚¨æ˜¯å¦åœ¨æ—¥æœˆæ½­ç¯„åœå…§...</p>
    </div>

    <!-- 3. ç¬¬ä¸€é—œï¼šå…¬è»Šå‰é€² -->
    <div id="view-game1" class="hidden flex flex-col p-6 flex-grow">
        <div class="mb-4"><span class="bg-teal-500 text-white px-3 py-1 rounded-full text-sm">é—œå¡ 1/3</span></div>
        <h2 class="text-2xl font-bold text-teal-900 mb-2">å¥½è¡Œå…¬è»Šå‡ºç™¼ï¼</h2>
        <p class="text-gray-600 mb-10">å¿«é€Ÿé»æ“Šè¢å¹•è®“å…¬è»ŠæŠµé”çµ‚é»ç«™</p>
        <div class="relative w-full h-40 bg-slate-50 rounded-3xl border-b-8 border-slate-200 overflow-hidden flex items-end pb-4" id="game1-area">
            <div id="bus-sprite" class="sprite-bus absolute left-0"></div>
            <div class="sprite-station absolute right-4"></div>
        </div>
    </div>

    <!-- 4. ç¬¬äºŒé—œï¼šç´…ç‰æ¡èŒ¶ -->
    <div id="view-game2" class="hidden flex flex-col p-6 flex-grow relative overflow-hidden">
        <div class="mb-4"><span class="bg-teal-500 text-white px-3 py-1 rounded-full text-sm">é—œå¡ 2/3</span></div>
        <h2 class="text-2xl font-bold text-teal-900 mb-2">å–”ç†Šæ¡èŒ¶æ¨‚</h2>
        <p class="text-gray-600 mb-4">å·¦å³æ»‘å‹•å–”ç†Šï¼Œæ¥ä½æ‰è½çš„ç´…ç‰èŒ¶è‘‰ (<span id="tea-count">0</span>/5)</p>
        <div id="game2-area" class="relative flex-grow bg-emerald-50 rounded-3xl border-2 border-emerald-100 overflow-hidden">
            <img id="ohbear-player" src="https://i.postimg.cc/3N9vTgMS/obear.png" class="absolute bottom-4 left-1/2 -translate-x-1/2 w-20 h-auto transition-all">
        </div>
    </div>

    <!-- 5. ç¬¬ä¸‰é—œï¼šä¸»è¦–è¦ºæ‹¼åœ– -->
    <div id="view-game3" class="hidden flex flex-col p-6 flex-grow">
        <div class="mb-4"><span class="bg-teal-500 text-white px-3 py-1 rounded-full text-sm">é—œå¡ 3/3</span></div>
        <h2 class="text-2xl font-bold text-teal-900 mb-2">æ‹¼å‡ºç¾æ™¯</h2>
        <p class="text-gray-600 mb-6">é»æ“Šæ‹¼åœ–å¡Šï¼Œå®Œæˆæ—¥æœˆæ½­ç¾æ™¯åœ–</p>
        <div class="grid grid-cols-2 gap-2 mx-auto mb-8" id="puzzle-board">
            <div class="puzzle-slot" data-id="0"></div>
            <div class="puzzle-slot" data-id="1"></div>
            <div class="puzzle-slot" data-id="2"></div>
            <div class="puzzle-slot" data-id="3"></div>
        </div>
        <div class="flex justify-center gap-4" id="puzzle-pieces">
            <!-- æ‹¼åœ–å¡Šç”± JS ç”Ÿæˆ -->
        </div>
    </div>

    <!-- 6. å…Œçç•«é¢ -->
    <div id="view-reward" class="hidden flex flex-col p-6 flex-grow bg-orange-50">
        <div class="bg-white rounded-3xl p-8 shadow-2xl border-t-8 border-orange-500 text-center">
            <div class="text-5xl mb-4">ğŸ</div>
            <h2 class="text-3xl font-black text-gray-800 mb-2">ä»»å‹™å®Œæˆï¼</h2>
            <p id="user-display" class="text-teal-600 font-bold mb-6">ç©å®¶ï¼šè¼‰å…¥ä¸­...</p>
            
            <div class="bg-gray-50 rounded-2xl p-4 mb-8">
                <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">å·¥ä½œäººå“¡æ ¸éŠ·å°ˆç”¨æ™‚é–“</p>
                <p id="live-clock" class="text-4xl font-mono font-bold text-gray-800">00:00:00</p>
            </div>

            <button id="btn-redeem" class="w-full bg-orange-500 text-white py-5 rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-all">
                å‡ºç¤ºçµ¦å·¥ä½œäººå“¡æ ¸éŠ·
            </button>
            <p class="text-xs text-gray-400 mt-4">æ ¸éŠ·å¾Œæ­¤åˆ¸å³å¤±æ•ˆ</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    // --- æ¸¬è©¦æ¨¡å¼è¨­å®š ---
    const DEBUG_MODE = true; // ğŸš© é–‹ç™¼æ¸¬è©¦æ™‚è«‹è¨­ç‚º trueï¼Œæ­£å¼ä¸Šç·šæ”¹ç‚º false

    if(DEBUG_MODE) document.getElementById('debug-tag').classList.remove('hidden');

    const firebaseConfig = {
        apiKey: "AIzaSyBXfkVMgl3A4n4VyBpqpegOygBnxjxJjF4",
        authDomain: "sml-bus-game.firebaseapp.com",
        projectId: "sml-bus-game",
        storageBucket: "sml-bus-game.firebasestorage.app",
        messagingSenderId: "62010261306",
        appId: "1:62010261306:web:1d9f1b0284c8aab82a9a03",
        measurementId: "G-5C5M38TPR2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    function showView(id) {
        document.querySelectorAll('#app > div').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${id}`).classList.remove('hidden');
    }

    // --- ç™»å…¥é‚è¼¯ ---
    document.getElementById('btn-login').onclick = async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            const user = result.user;
            const docSnap = await getDoc(doc(db, "players", user.uid));
            
            if (!DEBUG_MODE && docSnap.exists() && docSnap.data().isRedeemed) {
                alert('æ­¤å¸³è™Ÿå·²å…Œæ›éçå“å›‰ï¼');
                return;
            }

            if (!DEBUG_MODE && docSnap.exists() && docSnap.data().gameFinished) {
                initReward(user);
            } else {
                startGPS(user);
            }
        } catch (e) { alert('ç™»å…¥å‡ºéŒ¯: ' + e.message); }
    };

    // --- GPS é‚è¼¯ ---
    function startGPS(user) {
        showView('gps');
        if (DEBUG_MODE) {
            setTimeout(() => initGame1(), 1500);
            return;
        }
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const dist = Math.sqrt(Math.pow(pos.coords.latitude - 23.8647, 2) + Math.pow(pos.coords.longitude - 120.9168, 2));
                if (dist < 0.02) initGame1(); // ç´„ 2km
                else document.getElementById('gps-status').innerText = "å–”ç†Šç™¼ç¾ä½ ä¸åœ¨æ—¥æœˆæ½­è€¶ï¼è«‹æŠµé”ç¾å ´å¾Œå†ç©å§ã€‚";
            },
            () => { alert('è«‹é–‹å•Ÿå®šä½ä»¥ç¹¼çºŒ'); initGame1(); } // å¤±æ•—æš«æ™‚æ”¾è¡Œ
        );
    }

    // --- ç¬¬ä¸€é—œï¼šå…¬è»Š ---
    let busX = 0;
    function initGame1() {
        showView('game1');
        const area = document.getElementById('view-game1');
        const bus = document.getElementById('bus-sprite');
        area.onclick = () => {
            busX += 15;
            bus.style.transform = `translateX(${busX}px)`;
            if (busX > 200) { area.onclick = null; initGame2(); }
        };
    }

    // --- ç¬¬äºŒé—œï¼šæ¡èŒ¶ ---
    let score = 0;
    function initGame2() {
        showView('game2');
        const bear = document.getElementById('ohbear-player');
        const area = document.getElementById('game2-area');
        
        // æ»‘å‹•æ§åˆ¶
        area.ontouchmove = (e) => {
            let x = e.touches[0].clientX - area.getBoundingClientRect().left;
            bear.style.left = `${Math.max(40, Math.min(x, area.clientWidth - 40))}px`;
        };

        const interval = setInterval(() => {
            const leaf = document.createElement('div');
            leaf.innerText = "ğŸƒ";
            leaf.className = "absolute text-2xl transition-all duration-2000";
            leaf.style.left = Math.random() * 90 + "%";
            leaf.style.top = "-40px";
            area.appendChild(leaf);
            
            gsap.to(leaf, { top: "100%", duration: 2, onUpdate: () => {
                const b = bear.getBoundingClientRect();
                const l = leaf.getBoundingClientRect();
                if (l.top > b.top && l.left > b.left && l.left < b.right) {
                    leaf.remove(); score++;
                    document.getElementById('tea-count').innerText = score;
                    if (score >= 5) { clearInterval(interval); initGame3(); }
                }
            }, onComplete: () => leaf.remove() });
        }, 1000);
    }

    // --- ç¬¬ä¸‰é—œï¼šæ‹¼åœ– ---
    function initGame3() {
        showView('game3');
        const piecesArea = document.getElementById('puzzle-pieces');
        const slots = document.querySelectorAll('.puzzle-slot');
        let matched = 0;

        [0, 1, 2, 3].sort(() => Math.random() - 0.5).forEach(id => {
            const p = document.createElement('div');
            p.className = "puzzle-piece";
            p.style.backgroundPosition = `-${(id % 2) * 80}px -${Math.floor(id / 2) * 80}px`;
            p.onclick = () => {
                const target = slots[matched];
                gsap.to(p, { x: target.offsetLeft - p.offsetLeft, y: target.offsetTop - p.offsetTop, duration: 0.5 });
                target.style.border = "none";
                target.appendChild(p);
                matched++;
                if (matched === 4) setTimeout(() => initReward(auth.currentUser), 1000);
            };
            piecesArea.appendChild(p);
        });
    }

    // --- å…Œçç•«é¢ ---
    async function initReward(user) {
        showView('reward');
        document.getElementById('user-display').innerText = `ç©å®¶ï¼š${user.displayName}`;
        
        if (!DEBUG_MODE) {
            await setDoc(doc(db, "players", user.uid), {
                gameFinished: true,
                isRedeemed: false,
                name: user.displayName
            }, { merge: true });
        }

        setInterval(() => {
            document.getElementById('live-clock').innerText = new Date().toTimeString().split(' ')[0];
        }, 1000);

        document.getElementById('btn-redeem').onclick = async () => {
            if (confirm('å·¥ä½œäººå“¡ç¢ºèªå…Œæ›ï¼Ÿ')) {
                await setDoc(doc(db, "players", user.uid), { isRedeemed: true }, { merge: true });
                alert('é ˜å–æˆåŠŸï¼');
                location.reload();
            }
        };
    }
</script>
</body>
</html>
