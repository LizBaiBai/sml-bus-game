<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥æœˆæ½­å¥½è¡Œå¤§å†’éšª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: #f0fdfa; touch-action: manipulation; overflow: hidden; }
        .hidden { display: none !important; }
        #bus-img { width: 100px; position: absolute; left: 0; bottom: 10px; z-index: 10; transition: left 0.1s linear; }
        #station-img { width: 60px; position: absolute; right: 10px; bottom: 10px; z-index: 5; }
        .puzzle-slot { width: 85px; height: 85px; border: 2px dashed #99f6e4; background: #f1f5f9; position: relative; }
        .puzzle-piece { width: 85px; height: 85px; background-image: url('https://i.postimg.cc/VLd6vyXZ/zhu-shi-jue.jpg'); background-size: 170px 170px; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; position: relative; }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col bg-white shadow-2xl relative overflow-hidden">
    <div id="debug-tag" class="absolute top-0 left-0 bg-red-500 text-white text-[10px] px-2 z-50">æ¸¬è©¦æ¨¡å¼é–‹å•Ÿä¸­</div>

    <!-- 1. ç™»å…¥ -->
    <div id="view-login" class="flex flex-col items-center justify-center flex-grow p-6 text-center">
        <img src="https://i.postimg.cc/VLd6vyXZ/zhu-shi-jue.jpg" class="w-full rounded-2xl mb-8 shadow-lg">
        <h1 class="text-3xl font-black text-teal-800 mb-2">æ—¥æœˆæ½­å¥½è¡Œå¤§å†’éšª</h1>
        <p class="text-teal-600 mb-10">æ¢ç´¢é‚µæ—æ–‡åŒ–èˆ‡ç¾æ™¯</p>
        <button id="btn-login" class="w-full bg-teal-600 text-white py-4 rounded-2xl font-bold text-xl shadow-xl active:scale-95 transition-all">Google å¿«é€Ÿç™»å…¥</button>
    </div>

    <!-- 2. GPS -->
    <div id="view-gps" class="hidden flex flex-col items-center justify-center flex-grow p-8 text-center">
        <div class="w-20 h-20 bg-teal-100 rounded-full flex items-center justify-center mb-6 animate-bounce"><span class="text-4xl">ğŸ“</span></div>
        <h2 class="text-2xl font-bold mb-4">ç¢ºèªä½ç½®ä¸­...</h2>
        <p class="text-gray-500">æ­£åœ¨ç¢ºèªæ‚¨æ˜¯å¦åœ¨æ—¥æœˆæ½­ç¯„åœå…§</p>
    </div>

    <!-- 3. ç¬¬ä¸€é—œï¼šå…¬è»Š -->
    <div id="view-game1" class="hidden flex flex-col p-6 flex-grow">
        <h2 class="text-2xl font-bold text-teal-900 mb-2">ç¬¬ä¸€é—œï¼šå¥½è¡Œå‡ºç™¼</h2>
        <p class="text-gray-600 mb-8">é€£çºŒé»æ“Šç•«é¢ï¼Œè®“å…¬è»ŠæŠµé”ç«™ç‰Œï¼</p>
        <div class="relative w-full h-40 bg-slate-50 rounded-3xl border-b-8 border-slate-200" id="game1-area">
            <img id="bus-img" src="https://i.postimg.cc/pdG1czvf/Bus.png">
            <img id="station-img" src="https://i.postimg.cc/ZRnxWM1s/Bus-Staion.png">
        </div>
    </div>

    <!-- 4. ç¬¬äºŒé—œï¼šæ¡èŒ¶ -->
    <div id="view-game2" class="hidden flex flex-col p-6 flex-grow relative">
        <h2 class="text-2xl font-bold text-teal-900 mb-2">ç¬¬äºŒé—œï¼šå–”ç†Šæ¡èŒ¶</h2>
        <p class="text-gray-600">å·¦å³æ»‘å‹•æˆ–é»æ“Šä¾†ç§»å‹•å–”ç†Š (<span id="tea-count">0</span>/5)</p>
        <div id="game2-area" class="relative flex-grow bg-emerald-50 rounded-3xl mt-4 border-2 border-emerald-100 overflow-hidden">
            <img id="ohbear-player" src="https://i.postimg.cc/3N9vTgMS/obear.png" class="absolute bottom-4 left-1/2 -translate-x-1/2 w-24 h-auto pointer-events-none transition-all duration-100">
        </div>
    </div>

    <!-- 5. ç¬¬ä¸‰é—œï¼šæ‹¼åœ– -->
    <div id="view-game3" class="hidden flex flex-col p-6 flex-grow">
        <h2 class="text-2xl font-bold text-teal-900 mb-2">ç¬¬ä¸‰é—œï¼šæ‹¼å‡ºç¾æ™¯</h2>
        <div class="grid grid-cols-2 gap-2 mx-auto my-8" id="puzzle-board">
            <div class="puzzle-slot" data-id="0"></div>
            <div class="puzzle-slot" data-id="1"></div>
            <div class="puzzle-slot" data-id="2"></div>
            <div class="puzzle-slot" data-id="3"></div>
        </div>
        <div class="flex justify-center gap-4 flex-wrap" id="puzzle-pieces"></div>
    </div>

    <!-- 6. å…Œç -->
    <div id="view-reward" class="hidden flex flex-col p-6 flex-grow bg-orange-50 text-center">
        <div class="bg-white rounded-3xl p-8 shadow-2xl border-t-8 border-orange-500">
            <h2 class="text-3xl font-black mb-4 uppercase">ä»»å‹™å®Œæˆ</h2>
            <p id="user-display" class="font-bold text-teal-600 mb-6"></p>
            <div class="bg-gray-100 p-4 rounded-xl mb-6">
                <p id="live-clock" class="text-4xl font-mono font-bold">00:00:00</p>
            </div>
            <button id="btn-redeem" class="w-full bg-orange-500 text-white py-5 rounded-2xl font-black text-xl shadow-lg">å·¥ä½œäººå“¡æ ¸éŠ·</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    // --- æ ¸å¿ƒé…ç½® ---
    const DEBUG_MODE = true; 

    const firebaseConfig = {
        apiKey: "AIzaSyBXfkVMgl3A4n4VyBpqpegOygBnxjxJjF4",
        authDomain: "sml-bus-game.firebaseapp.com",
        projectId: "sml-bus-game",
        storageBucket: "sml-bus-game.firebasestorage.app",
        messagingSenderId: "62010261306",
        appId: "1:62010261306:web:1d9f1b0284c8aab82a9a03",
        measurementId: "G-5C5M38TPR2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    if(!DEBUG_MODE) document.getElementById('debug-tag').classList.add('hidden');

    function showView(id) {
        document.querySelectorAll('#app > div').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${id}`).classList.remove('hidden');
    }

    // --- ç™»å…¥æ§åˆ¶ (Redirect æ¨¡å¼) ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const docSnap = await getDoc(doc(db, "players", user.uid));
            if (!DEBUG_MODE && docSnap.exists() && docSnap.data().isRedeemed) {
                alert('å·²å…Œæ›éç¦®ç‰©ã€‚');
                return;
            }
            showView('game1');
            initGame1();
        }
    });

    getRedirectResult(auth).catch((e) => {
        console.error("é©—è­‰éŒ¯èª¤:", e);
        if(e.code === 'auth/unauthorized-domain') {
            alert('ç¶²åŸŸæˆæ¬ŠéŒ¯èª¤ã€‚è«‹ç¢ºèª Firebase å¾Œå°å·²åŠ å…¥ lizbaibai.github.io');
        }
    });

    document.getElementById('btn-login').onclick = () => {
        signInWithRedirect(auth, provider);
    };

    // --- ç¬¬ä¸€é—œï¼šå…¬è»Š ---
    let busLeft = 0;
    function initGame1() {
        const bus = document.getElementById('bus-img');
        const area = document.getElementById('view-game1');
        area.onclick = () => {
            busLeft += 20;
            bus.style.left = busLeft + 'px';
            if (busLeft > 230) {
                area.onclick = null;
                initGame2();
            }
        };
    }

    // --- ç¬¬äºŒé—œï¼šæ¡èŒ¶ ---
    let score = 0;
    function initGame2() {
        showView('game2');
        const bear = document.getElementById('ohbear-player');
        const area = document.getElementById('game2-area');
        
        const moveBear = (clientX) => {
            let rect = area.getBoundingClientRect();
            let x = clientX - rect.left;
            let targetX = Math.max(50, Math.min(x, rect.width - 50));
            bear.style.left = targetX + 'px';
        };

        area.onmousemove = (e) => moveBear(e.clientX);
        area.ontouchmove = (e) => moveBear(e.touches[0].clientX);
        area.onclick = (e) => moveBear(e.clientX);

        const leafInterval = setInterval(() => {
            const leaf = document.createElement('div');
            leaf.innerText = "ğŸƒ";
            leaf.className = "absolute text-3xl select-none";
            leaf.style.left = Math.random() * 80 + 10 + "%";
            leaf.style.top = "-40px";
            area.appendChild(leaf);
            
            gsap.to(leaf, { top: "105%", duration: 2.2, ease: "none", onUpdate: () => {
                const b = bear.getBoundingClientRect();
                const l = leaf.getBoundingClientRect();
                if (l.bottom > b.top && l.left > b.left - 20 && l.right < b.right + 20) {
                    leaf.remove(); score++;
                    document.getElementById('tea-count').innerText = score;
                    if (score >= 5) { 
                        clearInterval(leafInterval); 
                        area.onmousemove = area.ontouchmove = null; 
                        initGame3(); 
                    }
                }
            }, onComplete: () => leaf.remove() });
        }, 1000);
    }

    // --- ç¬¬ä¸‰é—œï¼šæ‹¼åœ– ---
    function initGame3() {
        showView('game3');
        const piecesArea = document.getElementById('puzzle-pieces');
        const slots = document.querySelectorAll('.puzzle-slot');
        let matched = 0;

        [0, 1, 2, 3].sort(() => Math.random() - 0.5).forEach(id => {
            const piece = document.createElement('div');
            piece.className = "puzzle-piece";
            piece.style.backgroundPosition = `-${(id % 2) * 85}px -${Math.floor(id / 2) * 85}px`;
            
            piece.onclick = () => {
                const targetSlot = slots[matched];
                targetSlot.appendChild(piece);
                piece.style.position = "static"; 
                piece.onclick = null;
                matched++;
                if (matched === 4) setTimeout(() => initReward(), 800);
            };
            piecesArea.appendChild(piece);
        });
    }

    // --- å…Œçç•«é¢ ---
    async function initReward() {
        showView('reward');
        const user = auth.currentUser;
        document.getElementById('user-display').innerText = `ç©å®¶ï¼š${user ? user.displayName : 'è¨ªå®¢'}`;
        
        if (!DEBUG_MODE && user) {
            await setDoc(doc(db, "players", user.uid), {
                gameFinished: true,
                isRedeemed: false,
                name: user.displayName
            }, { merge: true });
        }

        setInterval(() => {
            document.getElementById('live-clock').innerText = new Date().toTimeString().split(' ')[0];
        }, 1000);

        document.getElementById('btn-redeem').onclick = async () => {
            if(confirm('ç¢ºèªæ ¸éŠ·é ˜çï¼Ÿ')) {
                if(!DEBUG_MODE && user) {
                    await setDoc(doc(db, "players", user.uid), { isRedeemed: true }, { merge: true });
                }
                alert('å…Œæ›æˆåŠŸï¼');
                location.reload();
            }
        };
    }
</script>
</body>
</html>
