<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥æœˆæ½­å¥½è¡Œå¤§å†’éšª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: #f0fdfa; touch-action: manipulation; overflow: hidden; }
        .hidden { display: none !important; }
        /* ç¬¬ä¸€é—œç´ æ */
        #bus-img { width: 100px; position: absolute; left: 0; bottom: 10px; z-index: 10; transition: left 0.1s linear; }
        #station-img { width: 60px; position: absolute; right: 10px; bottom: 10px; z-index: 5; }
        /* æ‹¼åœ–æ¨£å¼ä¿®æ­£ */
        .puzzle-slot { width: 85px; height: 85px; border: 2px dashed #teal-200; background: #f1f5f9; position: relative; }
        .puzzle-piece { width: 85px; height: 85px; background-image: url('https://i.postimg.cc/VLd6vyXZ/zhu-shi-jue.jpg'); background-size: 170px 170px; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; position: relative; }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col bg-white shadow-2xl relative overflow-hidden">
    <div id="debug-tag" class="absolute top-0 left-0 bg-red-500 text-white text-[10px] px-2 z-50">æ¸¬è©¦æ¨¡å¼é–‹å•Ÿä¸­</div>

    <!-- 1. ç™»å…¥ -->
    <div id="view-login" class="flex flex-col items-center justify-center flex-grow p-6 text-center">
        <img src="https://i.postimg.cc/VLd6vyXZ/zhu-shi-jue.jpg" class="w-full rounded-2xl mb-8 shadow-lg">
        <h1 class="text-3xl font-black text-teal-800 mb-2">æ—¥æœˆæ½­å¥½è¡Œå¤§å†’éšª</h1>
        <button id="btn-login" class="w-full bg-teal-600 text-white py-4 rounded-2xl font-bold text-xl shadow-xl active:scale-95 transition-all">Google å¿«é€Ÿç™»å…¥</button>
    </div>

    <!-- 2. GPS -->
    <div id="view-gps" class="hidden flex flex-col items-center justify-center flex-grow p-8 text-center">
        <div class="w-20 h-20 bg-teal-100 rounded-full flex items-center justify-center mb-6 animate-bounce"><span class="text-4xl">ğŸ“</span></div>
        <h2 class="text-2xl font-bold mb-4">ç¢ºèªä½ç½®ä¸­...</h2>
    </div>

    <!-- 3. ç¬¬ä¸€é—œï¼šå…¬è»Š -->
    <div id="view-game1" class="hidden flex flex-col p-6 flex-grow">
        <h2 class="text-2xl font-bold text-teal-900 mb-2">ç¬¬ä¸€é—œï¼šå¥½è¡Œå‡ºç™¼</h2>
        <p class="text-gray-600 mb-8">é€£çºŒé»æ“Šç•«é¢ï¼Œè®“å…¬è»ŠæŠµé”ç«™ç‰Œï¼</p>
        <div class="relative w-full h-40 bg-slate-50 rounded-3xl border-b-8 border-slate-200" id="game1-area">
            <img id="bus-img" src="https://i.postimg.cc/pdG1czvf/Bus.png">
            <img id="station-img" src="https://i.postimg.cc/ZRnxWM1s/Bus-Staion.png">
        </div>
    </div>

    <!-- 4. ç¬¬äºŒé—œï¼šæ¡èŒ¶ -->
    <div id="view-game2" class="hidden flex flex-col p-6 flex-grow relative">
        <h2 class="text-2xl font-bold text-teal-900 mb-2">ç¬¬äºŒé—œï¼šå–”ç†Šæ¡èŒ¶</h2>
        <p class="text-gray-600">å·¦å³æ»‘å‹•å–”ç†Šæ¥èŒ¶è‘‰ (<span id="tea-count">0</span>/5)</p>
        <div id="game2-area" class="relative flex-grow bg-emerald-50 rounded-3xl mt-4 border-2 border-emerald-100 overflow-hidden">
            <img id="ohbear-player" src="https://i.postimg.cc/3N9vTgMS/obear.png" class="absolute bottom-4 left-1/2 -translate-x-1/2 w-24 h-auto pointer-events-none">
        </div>
    </div>

    <!-- 5. ç¬¬ä¸‰é—œï¼šæ‹¼åœ– -->
    <div id="view-game3" class="hidden flex flex-col p-6 flex-grow">
        <h2 class="text-2xl font-bold text-teal-900 mb-2">ç¬¬ä¸‰é—œï¼šæ‹¼å‡ºç¾æ™¯</h2>
        <div class="grid grid-cols-2 gap-2 mx-auto my-8" id="puzzle-board">
            <div class="puzzle-slot" data-id="0"></div>
            <div class="puzzle-slot" data-id="1"></div>
            <div class="puzzle-slot" data-id="2"></div>
            <div class="puzzle-slot" data-id="3"></div>
        </div>
        <div class="flex justify-center gap-4 flex-wrap" id="puzzle-pieces"></div>
    </div>

    <!-- 6. å…Œç -->
    <div id="view-reward" class="hidden flex flex-col p-6 flex-grow bg-orange-50 text-center">
        <div class="bg-white rounded-3xl p-8 shadow-2xl border-t-8 border-orange-500">
            <h2 class="text-3xl font-black mb-4 uppercase">ä»»å‹™å®Œæˆ</h2>
            <p id="user-display" class="font-bold text-teal-600 mb-6"></p>
            <div class="bg-gray-100 p-4 rounded-xl mb-6">
                <p id="live-clock" class="text-4xl font-mono font-bold">00:00:00</p>
            </div>
            <button id="btn-redeem" class="w-full bg-orange-500 text-white py-5 rounded-2xl font-black text-xl shadow-lg">å·¥ä½œäººå“¡æ ¸éŠ·</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const DEBUG_MODE = true; // æ¸¬è©¦å®Œè¨˜å¾—æ”¹ false
    const firebaseConfig = {
        apiKey: "AIzaSyBXfkVMgl3A4n4VyBpqpegOygBnxjxJjF4",
        authDomain: "sml-bus-game.firebaseapp.com",
        projectId: "sml-bus-game",
        storageBucket: "sml-bus-game.firebasestorage.app",
        messagingSenderId: "62010261306",
        appId: "1:62010261306:web:1d9f1b0284c8aab82a9a03",
        measurementId: "G-5C5M38TPR2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    function showView(id) {
        document.querySelectorAll('#app > div').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${id}`).classList.remove('hidden');
    }

    // --- ç™»å…¥ ---
    document.getElementById('btn-login').onclick = async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            showView('game1'); initGame1();
        } catch (e) { alert('ç™»å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª Firebase ç¶²åŸŸè¨­å®š'); }
    };

    // --- ç¬¬ä¸€é—œï¼šå…¬è»Š (ä¿®æ­£) ---
    let busLeft = 0;
    function initGame1() {
        const bus = document.getElementById('bus-img');
        const area = document.getElementById('view-game1');
        area.onclick = () => {
            busLeft += 15;
            bus.style.left = busLeft + 'px';
            if (busLeft > 220) { area.onclick = null; initGame2(); }
        };
    }

    // --- ç¬¬äºŒé—œï¼šæ¡èŒ¶ (ä¿®æ­£äº’å‹•) ---
    let score = 0;
    function initGame2() {
        showView('game2');
        const bear = document.getElementById('ohbear-player');
        const area = document.getElementById('game2-area');
        
        // æ»‘å‹•æˆ–é»æ“Šçš†å¯æ§åˆ¶å–”ç†Š
        const moveBear = (clientX) => {
            let rect = area.getBoundingClientRect();
            let x = clientX - rect.left;
            let targetX = Math.max(50, Math.min(x, rect.width - 50));
            bear.style.left = targetX + 'px';
        };

        area.onmousemove = (e) => moveBear(e.clientX);
        area.ontouchmove = (e) => moveBear(e.touches[0].clientX);
        area.onclick = (e) => moveBear(e.clientX);

        const leafInterval = setInterval(() => {
            const leaf = document.createElement('div');
            leaf.innerText = "ğŸƒ";
            leaf.className = "absolute text-3xl select-none";
            leaf.style.left = Math.random() * 80 + 10 + "%";
            leaf.style.top = "-40px";
            area.appendChild(leaf);
            
            gsap.to(leaf, { top: "105%", duration: 2.5, ease: "none", onUpdate: () => {
                const b = bear.getBoundingClientRect();
                const l = leaf.getBoundingClientRect();
                // åŠ å¤§ç¢°æ’åµæ¸¬ç¯„åœ
                if (l.bottom > b.top && l.left > b.left - 20 && l.right < b.right + 20) {
                    leaf.remove(); score++;
                    document.getElementById('tea-count').innerText = score;
                    if (score >= 5) { clearInterval(leafInterval); area.onmousemove = area.ontouchmove = null; initGame3(); }
                }
            }, onComplete: () => leaf.remove() });
        }, 1200);
    }

    // --- ç¬¬ä¸‰é—œï¼šæ‹¼åœ– (ä¿®æ­£é£›æ•£å•é¡Œ) ---
    function initGame3() {
        showView('game3');
        const piecesArea = document.getElementById('puzzle-pieces');
        const slots = document.querySelectorAll('.puzzle-slot');
        let matched = 0;

        [0, 1, 2, 3].sort(() => Math.random() - 0.5).forEach(id => {
            const piece = document.createElement('div');
            piece.className = "puzzle-piece";
            piece.style.backgroundPosition = `-${(id % 2) * 85}px -${Math.floor(id / 2) * 85}px`;
            
            piece.onclick = () => {
                const targetSlot = slots[matched];
                // ä¿®æ­£åº§æ¨™é‚è¼¯ï¼šå°‡æ‹¼åœ–ç§»å‹•åˆ°æ ¼å­çš„ä¸­å¿ƒ
                const rect = targetSlot.getBoundingClientRect();
                const containerRect = piece.parentElement.getBoundingClientRect();
                
                targetSlot.appendChild(piece);
                piece.style.position = "static"; 
                piece.onclick = null;
                matched++;
                if (matched === 4) setTimeout(() => initReward(), 1000);
            };
            piecesArea.appendChild(piece);
        });
    }

    function initReward() {
        showView('reward');
        document.getElementById('user-display').innerText = `ç©å®¶ï¼š${auth.currentUser.displayName}`;
        setInterval(() => {
            document.getElementById('live-clock').innerText = new Date().toTimeString().split(' ')[0];
        }, 1000);
        document.getElementById('btn-redeem').onclick = () => {
            if(confirm('æ ¸éŠ·æ›çå“ï¼Ÿ')) { alert('å…Œæ›æˆåŠŸï¼'); location.reload(); }
        };
    }
</script>
</body>
</html>
