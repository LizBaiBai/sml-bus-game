<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœˆæ½­å¥½è¡Œå¤§å†’éšª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #e0f2f1; overflow-x: hidden; }
        .game-card { border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); background: white; }
        .hidden { display: none; }
        #bus { width: 100px; transition: transform 0.2s; }
        #ohbear { width: 80px; position: absolute; bottom: 20px; }
        .puzzle-piece { cursor: move; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col p-4">
    <!-- 1. ç™»å…¥ç•«é¢ -->
    <div id="view-login" class="flex flex-col items-center justify-center flex-grow text-center">
        <img src="https://i.postimg.cc/VLd6vyXZ/zhu-shi-jue.jpg" class="w-full rounded-lg mb-6 shadow-lg">
        <h1 class="text-2xl font-bold text-teal-800 mb-4">æ—¥æœˆæ½­å¥½è¡Œå¤§å†’éšª</h1>
        <p class="text-gray-600 mb-8">æ­ä¹˜å°ç£å¥½è¡Œï¼Œæ”¶é›†åœ¨åœ°ç‰¹è‰²æ›å¥½ç¦®ï¼</p>
        <button id="btn-login" class="bg-orange-500 hover:bg-orange-600 text-white px-8 py-3 rounded-full font-bold text-lg shadow-md transform active:scale-95 transition">
            ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
        </button>
    </div>

    <!-- 2. GPS æª¢æŸ¥ç•«é¢ (éš±è—) -->
    <div id="view-gps" class="hidden flex flex-col items-center justify-center flex-grow text-center">
        <div class="p-6 bg-white rounded-2xl shadow-xl">
            <span class="text-6xl mb-4 block">ğŸ“</span>
            <h2 class="text-xl font-bold mb-2">ç¢ºèªæ‚¨çš„ä½ç½®</h2>
            <p id="gps-status" class="text-gray-500 mb-4">æ­£åœ¨ç¢ºèªæ‚¨æ˜¯å¦åœ¨æ—¥æœˆæ½­ç¯„åœå…§...</p>
        </div>
    </div>

    <!-- 3. éŠæˆ²é—œå¡ï¼šå…¬è»Šå‰é€² -->
    <div id="view-game1" class="hidden flex flex-col items-center justify-center flex-grow text-center">
        <h2 class="text-xl font-bold text-teal-700 mb-4">ç¬¬ä¸€é—œï¼šå¥½è¡Œå‡ºç™¼ï¼</h2>
        <p class="text-sm text-gray-500 mb-8">é»æ“Šè¢å¹•è®“å…¬è»ŠæŠµé”æ—¥æœˆæ½­ç«™</p>
        <div class="relative w-full h-48 bg-gray-100 rounded-lg overflow-hidden border-b-4 border-teal-500">
            <img id="bus" src="https://i.postimg.cc/MKCWGn6z/busandbusstaion-png.png" style="clip-path: inset(0 60% 0 0);" class="absolute left-0 bottom-4">
            <img src="https://i.postimg.cc/MKCWGn6z/busandbusstaion-png.png" style="clip-path: inset(0 0 0 85%);" class="absolute right-2 bottom-4 w-12">
        </div>
        <div class="mt-8 text-xs text-gray-400">é»æ“Šç•«é¢ä»»ä½•åœ°æ–¹å‰é€²</div>
    </div>

    <!-- 4. å…Œçæ†‘è­‰ (ç¥¨å¤¾) -->
    <div id="view-reward" class="hidden flex flex-col items-center justify-center flex-grow">
        <div class="w-full bg-white rounded-3xl p-6 border-4 border-dashed border-orange-300 relative overflow-hidden">
            <div class="absolute -right-4 -top-4 bg-orange-500 text-white px-8 py-2 rotate-45">é™é‡ç¦®ç‰©</div>
            <h2 class="text-2xl font-black text-teal-800 mb-2">å¥½è¡Œå…Œæ›åˆ¸</h2>
            <p id="user-name" class="text-gray-600 font-bold mb-4">ç©å®¶ï¼šè¼‰å…¥ä¸­...</p>
            <div class="bg-teal-50 p-4 rounded-xl text-center mb-6">
                <p class="text-sm text-teal-600 uppercase tracking-widest">ç›®å‰æ ¸éŠ·æ™‚é–“</p>
                <p id="live-time" class="text-3xl font-mono font-bold text-teal-800">00:00:00</p>
            </div>
            <p class="text-xs text-red-500 mb-6 font-bold text-center">âš ï¸ è«‹å°‡æ­¤ç•«é¢å‡ºç¤ºçµ¦å·¥ä½œäººå“¡æ ¸éŠ·ï¼Œè«‹å‹¿è‡ªè¡Œé»æ“ŠæŒ‰éˆ•</p>
            <button id="btn-redeem" class="w-full bg-teal-600 text-white py-4 rounded-xl font-bold text-xl shadow-lg active:bg-teal-700">
                å·¥ä½œäººå“¡é»æ“Šæ ¸éŠ·
            </button>
        </div>
    </div>
</div>

<script type="module">
    // --- 1. Firebase åˆå§‹åŒ– ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBXfkVMgl3A4n4VyBpqpegOygBnxjxJjF4",
        authDomain: "sml-bus-game.firebaseapp.com",
        projectId: "sml-bus-game",
        storageBucket: "sml-bus-game.firebasestorage.app",
        messagingSenderId: "62010261306",
        appId: "1:62010261306:web:1d9f1b0284c8aab82a9a03",
        measurementId: "G-5C5M38TPR2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // --- 2. è®Šæ•¸èˆ‡è¦–åœ–æ§åˆ¶ ---
    const views = ['login', 'gps', 'game1', 'reward'];
    function showView(viewName) {
        views.forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
        document.getElementById(`view-${viewName}`).classList.remove('hidden');
    }

    // --- 3. é‚è¼¯è™•ç† ---

    // ç™»å…¥
    document.getElementById('btn-login').onclick = async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            checkUserStatus(result.user);
        } catch (error) {
            alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
        }
    };

    async function checkUserStatus(user) {
        const docRef = doc(db, "players", user.uid);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists() && docSnap.data().isRedeemed) {
            alert('æ‚¨å·²ç¶“å…Œæ›éç¦®ç‰©å›‰ï¼');
            return;
        }

        if (docSnap.exists() && docSnap.data().gameFinished) {
            startRewardView(user);
        } else {
            showView('gps');
            checkGPS(user);
        }
    }

    // GPS æª¢æŸ¥ (æ—¥æœˆæ½­ä¸­å¿ƒåº§æ¨™)
    function checkGPS(user) {
        if (!navigator.geolocation) {
            alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½ï¼Œæš«æ™‚é–‹æ”¾é«”é©—');
            showView('game1');
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                // é€™è£¡è¨­ä¸€å€‹è¼ƒå¯¬é¬†çš„ç¯„åœæ¸¬è©¦ (æˆ–å¯ç›´æ¥è·³éæª¢æŸ¥æ–¹ä¾¿æ¸¬è©¦)
                showView('game1'); 
            },
            (err) => {
                alert('è«‹é–‹å•Ÿå®šä½æ¬Šé™ä»¥é€²è¡ŒéŠæˆ²ï¼');
                showView('game1'); // æ¸¬è©¦æœŸé–“å…ˆè®“å®ƒé
            }
        );
    }

    // ç¬¬ä¸€é—œï¼šå…¬è»ŠéŠæˆ²
    let busPos = 0;
    document.getElementById('view-game1').onclick = () => {
        busPos += 10;
        document.getElementById('bus').style.left = busPos + 'px';
        if (busPos > 250) {
            finishGame();
        }
    };

    async function finishGame() {
        const user = auth.currentUser;
        await setDoc(doc(db, "players", user.uid), {
            name: user.displayName,
            email: user.email,
            gameFinished: true,
            isRedeemed: false,
            timestamp: new Date()
        }, { merge: true });
        startRewardView(user);
    }

    function startRewardView(user) {
        showView('reward');
        document.getElementById('user-name').innerText = `ç©å®¶ï¼š${user.displayName}`;
        setInterval(() => {
            const now = new Date();
            document.getElementById('live-time').innerText = now.toTimeString().split(' ')[0];
        }, 1000);
    }

    // æ ¸éŠ·æŒ‰éˆ•
    document.getElementById('btn-redeem').onclick = async () => {
        if (confirm('ç¢ºå®šè¦æ ¸éŠ·æ›çå“å—ï¼Ÿ(æ­¤æ“ä½œç”±å·¥ä½œäººå“¡åŸ·è¡Œ)')) {
            const user = auth.currentUser;
            await setDoc(doc(db, "players", user.uid), { isRedeemed: true }, { merge: true });
            alert('å…Œæ›æˆåŠŸï¼');
            location.reload();
        }
    };

</script>
</body>
</html>